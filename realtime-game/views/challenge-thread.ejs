<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= challenge.title %> - Challenge Thread</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/navbar.css">

  <style>
    :root{
      --ink:#0f0f14;
      --muted:#6b6b6b;
      --panel:rgba(255,255,255,.9);
      --panel-br:rgba(0,0,0,.08);
      --accent:#6e38ff;
      --pill:#f7f3ff;
      --hover:#f7f3ff;
    }
    body.dark-mode{
      --ink:#f1f1f1;
      --muted:#bdbdbd;
      --panel:rgba(28,28,32,.92);
      --panel-br:rgba(255,255,255,.08);
      --pill:rgba(110,56,255,.18);
      --hover:rgba(110,56,255,.12);
    }

    .page-wrap{
      max-width: 1100px;
      width: min(1100px, 100% - 24px);
      margin: 14px auto 28px;
      display: grid;
      gap: 12px;
    }

    /* HERO */
    .hero{
      background: var(--panel);
      border: 1px solid var(--panel-br);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08), 0 1px 0 rgba(255,255,255,.6) inset;
      backdrop-filter: blur(6px);
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    }
    .hero h1{ margin:0; font-size:1.35rem; font-weight:800; color:var(--ink); }
    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.6rem .9rem; border-radius:12px; text-decoration:none;
      border:1px solid #6e38ff33; background:#6e38ff; color:#fff;
      box-shadow:0 6px 16px rgba(110,56,255,.35);
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    .btn.secondary{ background: transparent; color: var(--accent); border:1px solid var(--accent); box-shadow:none; }

    /* GRID LAYOUT */
    .content-grid{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap: 12px;
    }
    @media (max-width: 980px){
      .content-grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--panel-br);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08), 0 1px 0 rgba(255,255,255,.6) inset;
      color: var(--ink);
    }
    .card h3{ margin: 0 0 8px; }

    .divider{ height:1px; background: var(--panel-br); margin: 10px 0; }

    /* CHALLENGE CARD */
    .challenge-desc{ line-height:1.55; }
    .meta{
      display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.4rem;
    }
    .chip{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.35rem .6rem; border-radius:999px;
      background: rgba(110,56,255,.14);
      border:1px solid rgba(110,56,255,.35);
      font-size:.85rem;
    }

    /* INTERACTIVE AREA placeholder */
    .interactive{
      display:grid; place-items:center;
      min-height: 140px;
      background: linear-gradient(180deg, var(--pill), transparent);
      border:1px dashed var(--panel-br);
      border-radius: 12px;
      color: var(--muted);
      text-align:center;
      padding: 12px;
    }

    /* REPLIES */
    .replies-header{
      display:flex; justify-content:space-between; align-items:center; gap:.5rem;
    }
    .replies-count{ color: var(--muted); }
    .toggle-btn{
      border:1px solid var(--panel-br);
      background: #fff; color: var(--ink);
      padding:.5rem .75rem; border-radius:10px; cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .toggle-btn:hover{ background: var(--hover); border-color: rgba(110,56,255,.35); }
    body.dark-mode .toggle-btn{ background:#1f1f1f; color:#f1f1f1; }

    .comment-list{ list-style:none; padding:0; margin:10px 0 0; display:flex; flex-direction:column; gap:12px; }

    .comment{
      display:grid; grid-template-columns: 36px 1fr; gap:10px; align-items:flex-start;
      background: linear-gradient(180deg, #fff, #fafafa);
      border:1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 10px;
    }
    body.dark-mode .comment{
      background: linear-gradient(180deg, #1f1f1f, #1b1b1b);
      border-color: rgba(255,255,255,.08);
    }
    .comment-avatar{
      width:36px;height:36px;border-radius:50%;object-fit:cover;background:#f2f2f2;
    }
    /* default avatar tint by guild */
    body.Fire  .avatar--default { filter: sepia(1) hue-rotate(150deg) saturate(4.2) brightness(.95) contrast(1.05); }
    body.Water .avatar--default { filter: hue-rotate(-10deg) saturate(1.4) brightness(1.05); }
    body.Earth .avatar--default { filter: sepia(1) hue-rotate(-120deg) saturate(3.2) brightness(.98) contrast(1.03); }

    .comment-body{ display:flex; flex-direction:column; gap:6px; color:var(--ink); }
    .comment-head{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    .comment-head strong{ font-weight:800; }
    .comment-time{ opacity:.75; font-size:.9rem; }
    .comment-text{ line-height:1.55; }
    .comment-attachment img{
      max-width: 260px; border-radius: 10px; display:block;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

    /* COLLAPSE LOGIC */
    .collapsed .comment{ display:none; }
    .collapsed .comment.__preview{ display:grid; } /* first few */
    .no-comments-note{
      text-align:center; color:var(--muted); padding: 10px 0;
      background: var(--pill); border:1px dashed var(--panel-br); border-radius:12px;
    }

    /* COMPOSER ‚Äì unified with Events style */
    .composer{
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    }
    .composer input[type="text"]{
      width:100%; padding:.7rem .8rem;
      border:1px solid var(--panel-br); border-radius:12px;
      background:#fff; color:var(--ink);
    }
    body.dark-mode .composer input[type="text"]{
      background:#202020; color:#f1f1f1; border-color: rgba(255,255,255,.08);
    }
    .composer .right{ display:flex; gap:10px; align-items:center; }

    /* Pretty file button */
    .file-btn{
      position: relative;
      overflow: hidden;
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.6rem .8rem; border-radius:12px; cursor:pointer;
      border:1px solid var(--panel-br); background:#fff; color:var(--ink);
      transition: background .15s ease, border-color .15s ease;
    }
    .file-btn:hover{ background: var(--hover); border-color: rgba(110,56,255,.35); }
    body.dark-mode .file-btn{ background:#1f1f1f; color:#f1f1f1; border-color: rgba(255,255,255,.12); }
    .file-btn input[type="file"]{
      position:absolute; inset:0; opacity:0; cursor:pointer;
    }

    .post-btn{
      border:1px solid #6e38ff33; background:#6e38ff; color:#fff;
      padding:.65rem .9rem; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(110,56,255,.35);
    }
    .post-btn:hover{ filter:brightness(1.05); }
  </style>
</head>
<body class="<%= guild %>">

  <%- include('partials/navbar', { user, guild, points, online }) %>

  <main class="page-wrap">
    <!-- HERO -->
    <section class="hero">
      <h1><%= challenge.title %></h1>
      <a class="btn secondary" href="/challenges">‚Üê Back to Challenges</a>
    </section>

    <section class="content-grid">
      <!-- LEFT: Challenge + Replies -->
      <div class="left-col" style="display:flex; flex-direction:column; gap:12px;">
        <!-- CHALLENGE DETAILS -->
        <article class="card">
          <h3>About this challenge</h3>
          <p class="challenge-desc"><%= challenge.description || 'No description provided.' %></p>
          <div class="divider"></div>
          <div class="meta">
            <span class="chip">üè∑Ô∏è ID: <b>#<%= challenge.id %></b></span>
            <span class="chip">üõ°Ô∏è Guild: <b><%= guild %></b></span>
          </div>
        </article>

        <!-- INTERACTIVE AREA PLACEHOLDER -->
        <article class="card">
          <h3>Interactive Area (coming soon)</h3>
          <div class="interactive">
            Mini-games and interactive challenges will appear here.
            <br>We kept this space ready for your future features.
          </div>
        </article>

        <!-- REPLIES -->
        <article class="card" id="repliesCard">
          <div class="replies-header">
            <h3 style="margin:0;">Replies</h3>
            <div>
              <span class="replies-count"><%= (challenge.comments && challenge.comments.length) || 0 %> total</span>
              <% const total = (challenge.comments && challenge.comments.length) || 0; %>
              <% if (total > 3) { %>
                <button class="toggle-btn" id="toggleReplies">View all <%= total %> replies</button>
              <% } %>
            </div>
          </div>

          <% if (!challenge.comments || challenge.comments.length === 0) { %>
            <div class="no-comments-note">No replies yet. Be the first to post!</div>
          <% } else { %>
            <ul class="comment-list <%= (challenge.comments.length > 3) ? 'collapsed' : '' %>" id="commentList">
              <% challenge.comments.forEach((c, idx) => { %>
                <li class="comment <%= (idx < 3) ? '__preview' : '' %>">
                  <img
                    src="<%= c.avatar || '/uploads/default.png' %>"
                    class="comment-avatar <%= (!c.avatar || c.avatar === '/uploads/default.png') ? 'avatar--default' : '' %>"
                    alt="<%= c.user %>">

                  <div class="comment-body">
                    <div class="comment-head">
                      <strong><%= c.user %></strong>
                      <% if (c.ts) { %>
                        <span class="comment-time"><%= new Date(c.ts).toLocaleString() %></span>
                      <% } %>
                    </div>

                    <div class="comment-text"><%= c.text %></div>

                    <% if (c.attachment) { %>
                      <div class="comment-attachment" style="margin-top:.25rem;">
                        <% if (/\.(png|jpe?g|gif|webp)$/i.test(c.attachment)) { %>
                          <a class="link" href="<%= c.attachment %>" target="_blank" rel="noopener">
                            <img src="<%= c.attachment %>" alt="attachment">
                          </a>
                        <% } else { %>
                          <a class="link" href="<%= c.attachment %>" target="_blank" rel="noopener">View attachment</a>
                        <% } %>
                      </div>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </article>

        <!-- COMPOSER -->
        <form class="card composer" method="POST" action="/challenges/<%= challenge.id %>/comment" enctype="multipart/form-data">
          <input name="text" placeholder="Add a reply‚Ä¶" maxlength="1000" required />
          <div class="right">
            <label class="file-btn" title="Attach image or file">
              üìé Attach
              <input type="file" name="attachment" accept="image/*,.pdf,.zip,.txt" />
            </label>
            <button class="post-btn" type="submit">Post</button>
          </div>
        </form>
      </div>

      <!-- RIGHT: Side panel -->
      <aside class="card" style="height:fit-content; position:sticky; top:12px;">
        <h3 class="subtle" style="margin:0 0 6px; opacity:.8;">Thread info</h3>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div><b>Title:</b> <%= challenge.title %></div>
          <div><b>Guild:</b> <%= guild %></div>
          <div><b>Replies:</b> <%= (challenge.comments && challenge.comments.length) || 0 %></div>
        </div>
        <div class="divider"></div>
        <a class="btn secondary" href="/challenges">‚Üê Back to Challenges</a>
      </aside>
    </section>
  </main>

  <script>
    // Collapsible replies: show first 3, toggle the rest
    (function(){
      const list = document.getElementById('commentList');
      const btn  = document.getElementById('toggleReplies');
      if (!list || !btn) return;

      let expanded = false;
      btn.addEventListener('click', () => {
        expanded = !expanded;
        if (expanded) {
          list.classList.remove('collapsed');
          btn.textContent = 'Hide replies';
        } else {
          list.classList.add('collapsed');
          const total = list.querySelectorAll('.comment').length;
          btn.textContent = `View all ${total} replies`;
          // Scroll back to top of replies for nicer UX
          document.getElementById('repliesCard')?.scrollIntoView({ behavior:'smooth', block:'start' });
        }
      });
    })();
  </script>

</body>
</html>
